geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
facet_wrap(.~type, ncol = 4) +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=15),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=12),
panel.background = element_rect(fill = "white", colour = "grey50"))
Corr_NRT2.1_genes_cellWall <- inner_join(Rcor_NRT2.1_genes_cellWall, Pcor_NRT2.1_genes_cellWall, by="gene") %>%
filter(gene!="AT1G08090") %>%
drop_na()
Corr_NRT2.1_genes_cellWall
Corr_NRT2.1_genes_all_groups <- bind_rows(Corr_NRT2.1_genes_Glycolysis, Corr_NRT2.1_genes_Asp_family_pathway, Corr_NRT2.1_genes_ATP_biosynthesis, Corr_NRT2.1_genes_Photosynthesis,Corr_NRT2.1_genes_TCAcycle_mitocondrialET, Corr_NRT2.1_genes_Tetrapyrrole, Corr_NRT2.1_genes_Nnutrition, Corr_NRT2.1_genes_cellWall) %>%
mutate(Pthreshold=ifelse(Pcor<0.05, yes="less0.05", no="more0.05"))
ggplot(Corr_NRT2.1_genes_all_groups, aes(x=Pcor, y=Rcor, col=type)) +
geom_point()
mutate(Corr_NRT2.1_genes_all_groups, type=factor(type, levels=c("Photosynthesis", "Glycolysis", "Nnutrition",
"Tetrapyrrole", "cell_wall", "Asp_family_pathway", "TCAcycle_mitocondrialET",
"ATP_biosynthesis")),
logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr, col=Pthreshold)) +
geom_point(size=3, alpha=0.6) +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
facet_wrap(.~type, ncol = 4) +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=15),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=12),
panel.background = element_rect(fill = "white", colour = "grey50"))
ggsave(file="volcano_plot_cor_energy_genes_NRT2.2.jpg", width=12, height=7)
group_by(Corr_NRT2.1_genes_all_groups,type, Pthreshold) %>%  summarise(nb=n()) %>%  pivot_wider(names_from = Pthreshold, values_from = nb) %>%  mutate(PercSignif=(less0.05/(less0.05+more0.05))*100, tot=less0.05+more0.05)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(matrixStats)
library(statmod)
library(scTenifoldNet)
library(RColorBrewer)
library(gplots)
library(topGO)
library(psych)
library(ggpubr)
gene_types <- read_tsv("SC18_data/Genes_interest.txt")
SC18_all_WT <- read_tsv("SC18_data/SC18_Raw_HTSeq_WT.txt") %>%
column_to_rownames(var="gene")
CPMnorm_SC18_all_WT <- cpmNormalization(SC18_all_WT)
CPM_SC18_all_WT <- as.data.frame.matrix(CPMnorm_SC18_all_WT)
CPM_SC18_all_WT_Zscore <- mutate_all(CPM_SC18_all_WT, funs("Zscore" = (.-rowMeans(CPM_SC18_all_WT[,1:24], na.rm=TRUE))/rowSds(as.matrix(CPM_SC18_all_WT[,1:24])))) %>%
dplyr::select( contains("Zscore")) %>%
rename_with(~ gsub("_Zscore", "", .x, fixed = TRUE)) %>%
rownames_to_column(var="gene")
BrenneckeGetVariableGenesMod <- function(expr_mat, spikes=NA, suppress.plot=FALSE, fdr=0.1, minBiolDisp=0.5, fitMeanQuantile=0.8) {
#require(statmod)
rowVars <- function(x) { unlist(apply(x,1,var, na.rm=TRUE))}
colGenes <- "black"
colSp <- "blue"
fullCountTable <- expr_mat;
if (is.character(spikes)) {
sp <- rownames(fullCountTable) %in% spikes;
countsSp <- fullCountTable[sp,];
countsGenes <- fullCountTable[!sp,];
} else if (is.numeric(spikes)) {
countsSp <- fullCountTable[spikes,];
countsGenes <- fullCountTable[-spikes,];
} else {
countsSp <- fullCountTable;
countsGenes <- fullCountTable;
}
meansSp <- rowMeans(countsSp, na.rm=TRUE)
varsSp <- rowVars(countsSp)
cv2Sp <- varsSp/meansSp^2
meansGenes <- rowMeans(countsGenes, na.rm=TRUE)
varsGenes <- rowVars(countsGenes)
cv2Genes <- varsGenes/meansGenes^2
# Fit Model
minMeanForFit <- unname( quantile( meansSp[ which( cv2Sp > 0.3 ) ], fitMeanQuantile))
useForFit <- meansSp >= minMeanForFit
if (sum(useForFit, na.rm=TRUE) < 20) {
warning("Too few spike-ins exceed minMeanForFit, recomputing using all genes.")
meansAll <- c(meansGenes, meansSp)
cv2All <- c(cv2Genes,cv2Sp)
minMeanForFit <- unname( quantile( meansAll[ which( cv2All > 0.3 ) ], 0.80))
useForFit <- meansSp >= minMeanForFit
}
if (sum(useForFit, na.rm=TRUE) < 30) {warning(paste("Only", sum(useForFit), "spike-ins to be used in fitting, may result in poor fit."))}
fit <- glmgam.fit( cbind( a0 = 1.5, a1tilde = 1.1/meansSp[useForFit] ), cv2Sp[useForFit] )
a0 <- unname( fit$coefficients["a0"] )
a1 <- unname( fit$coefficients["a1tilde"])
res <- cv2Genes - (a0 + a1/meansGenes);
# Test
psia1theta <- a1
minBiolDisp <- minBiolDisp^2
m <- ncol(countsSp);
cv2th <- a0 + minBiolDisp + a0 * minBiolDisp
testDenom <- (meansGenes*psia1theta + meansGenes^2*cv2th)/(1+cv2th/m)
p <- 1-pchisq(varsGenes * (m-1)/testDenom,m-1)
padj <- p.adjust(p,"BH")
sig <- padj < fdr
sig[is.na(sig)] <- FALSE
if (!suppress.plot) {
plot( meansGenes,cv2Genes, xaxt="n", yaxt="n", log="xy",
xlab = "average normalized read count",
ylab = "squared coefficient of variation (CV^2)", col="white")
axis( 1, 10^(-2:5), c( "0.01", "0.1", "1", "10", "100", "1000",
expression(10^4), expression(10^5) ) )
axis( 2, 10^(-2:3), c( "0.01", "0.1", "1", "10", "100","1000" ), las=2 )
abline( h=10^(-2:1), v=10^(-1:5), col="#D0D0D0", lwd=2 )
# Plot the genes, use a different color if they are highly variable
#points( meansGenes, cv2Genes, pch=19, cex=.6,
#        col = alpha(ifelse( padj < .1, "blue", colGenes ), 1) )
# Plot/highlight the spike-ins if they are different from the genes
#if (length(meansSp) < length(meansGenes)) {
#  points(meansSp, cv2Sp, pch=20, cex=.5, col=colSp)
#}
# Add the technical noise fit
#xg <- 10^seq( -2, 6, length.out=1000 )
#lines( xg, (a1)/xg + a0, col="red", lwd=3 )
# Add a curve showing the expectation for the chosen biological CV^2 thershold
#lines( xg, psia1theta/xg + a0 + minBiolDisp, lty="dashed", col="purple", lwd=3)
}
TABLE <- data.frame(Gene = names(meansGenes), effect.size=res, p.value = p, q.value= padj, Mean=meansGenes, CV2=cv2Genes ,
TechNoise=(a1)/meansGenes+a0, BioVar=log2(cv2Genes/((a1)/meansGenes+a0)))
TABLE <- TABLE[order(-TABLE[,2]),];
return(list(data=TABLE,A0=a0,A1=a1))
}
CPM_SC18_all_WT_expr <-  filter(CPM_SC18_all_WT, rowMeans(CPM_SC18_all_WT[,1:24])>=5&
rowSums(CPM_SC18_all_WT[1:22]<0.0001)<5)
Gene_size <- read_tsv("SC18_data/TAIR10_Gene_sizes.txt") %>%
dplyr::select(gene_name,length)
Genes_more150bp <-filter(Gene_size,length>150)
CPM_SC18_all_WT_expr <- rownames_to_column(CPM_SC18_all_WT_expr, var="gene") %>%
inner_join( Genes_more150bp, by=c("gene"="gene_name")) %>%
dplyr::select(-length) %>%
column_to_rownames(var="gene") %>%
as.data.frame()
CPM_SC18_all_WT_expr_Brennecke <- BrenneckeGetVariableGenesMod(CPM_SC18_all_WT_expr, minBiolDisp = 0.1, fdr=0.01)
CPM_SC18_all_WT_expr_a0 <-CPM_SC18_all_WT_expr_Brennecke$A0
CPM_SC18_all_WT_expr_a1 <- CPM_SC18_all_WT_expr_Brennecke$A1
CPM_SC18_all_WT_expr_Brennecke_data <- CPM_SC18_all_WT_expr_Brennecke$data
CPM_SC18_all_WT_expr_HVG <- filter(CPM_SC18_all_WT_expr_Brennecke_data, q.value<0.01)
CPM_SC18_all_WT_expr_Brennecke_genes_interest <- inner_join(CPM_SC18_all_WT_expr_Brennecke_data, gene_types, by=c("Gene"="gene"))
ggplot(CPM_SC18_all_WT_expr_Brennecke_data, aes(x=Mean, y=CV2)) +
geom_point() +
scale_x_log10() + scale_y_log10() +
xlab("Mean expression") +
ylab(bquote(CV^2)) +
geom_point(data=CPM_SC18_all_WT_expr_HVG,col="blue") +
geom_point(data=CPM_SC18_all_WT_expr_Brennecke_genes_interest, aes(col=type),  size=5) +
scale_color_brewer(palette = "Dark2", name="Type of gene",
labels=expression("Nitrate assimilation",
"Nitrate transporters",
paste("Negative regulator of ", italic("NRT2.1"), " transcription"),
italic("NRT2.1"),
"NRT2.1 protein regulator",
paste("Positive regulator of ", italic("NRT2.1"), " transcription"))) +
theme_classic() +
theme(text = element_text(size = 20))
ggsave("Variability_graph_genes_nitrate_nutrition.jpg", width=11, height = 4)
View(CPM_SC18_all_WT_expr_HVG)
View(CPM_SC18_all_WT_expr_Brennecke_data)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(matrixStats)
library(statmod)
library(scTenifoldNet)
library(RColorBrewer)
library(gplots)
library(topGO)
library(psych)
library(ggpubr)
gene_types <- read_tsv("SC18_data/Genes_interest.txt")
SC18_all_WT <- read_tsv("SC18_data/SC18_Raw_HTSeq_WT.txt") %>%
column_to_rownames(var="gene")
CPMnorm_SC18_all_WT <- cpmNormalization(SC18_all_WT)
CPM_SC18_all_WT <- as.data.frame.matrix(CPMnorm_SC18_all_WT)
CPM_SC18_all_WT_Zscore <- mutate_all(CPM_SC18_all_WT, funs("Zscore" = (.-rowMeans(CPM_SC18_all_WT[,1:24], na.rm=TRUE))/rowSds(as.matrix(CPM_SC18_all_WT[,1:24])))) %>%
dplyr::select( contains("Zscore")) %>%
rename_with(~ gsub("_Zscore", "", .x, fixed = TRUE)) %>%
rownames_to_column(var="gene")
AllClusters <- read_tsv("6clusters_genesCVsup1_NRT21.txt")
Cluster1_long <- filter(AllClusters, cluster_6_pearson==1) %>%
pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")
NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>%
pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>%
mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))
ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
geom_line(size=1.5, aes(group=gene)) +
geom_smooth(data=Cluster1_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
scale_color_manual(values="#8DD3C7") +
ylab("Zscore normalised expression") +
ggtitle("Expression in cluster 1") +
theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"),
axis.text=element_text(size=16), axis.title=element_text(size=16),
plot.title = element_text(size=18),
panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(),
legend.position = "none")
ggsave("Expression_cluster1_NRT2.1.jpg", width=5, height = 5)
Cluster1_long <- filter(AllClusters, cluster_6_pearson==1) %>%
pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")
NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>%
pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>%
mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))
ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
geom_line(size=1.5, aes(group=gene)) +
geom_smooth(data=Cluster1_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
scale_color_manual(values="#8DD3C7") +
ylab("Zscore normalised expression") +
ggtitle("Expression in cluster 1") +
theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"),
axis.text=element_text(size=16), axis.title=element_text(size=18),
plot.title = element_text(size=20),
panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(),
legend.position = "none")
ggsave("Expression_cluster1_NRT2.1.jpg", width=4, height = 4)
Cluster1_long <- filter(AllClusters, cluster_6_pearson==1) %>%
pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")
NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>%
pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>%
mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))
ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
geom_line(size=1.5, aes(group=gene)) +
geom_smooth(data=Cluster1_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
scale_color_manual(values="#8DD3C7") +
ylab("Zscore normalised expression") +
ggtitle("Expression in cluster 1") +
theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"),
axis.text=element_text(size=16), axis.title=element_text(size=18),
plot.title = element_text(size=20),
panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(),
legend.position = "none")
ggsave("Expression_cluster1_NRT2.1.jpg", width=4.5, height = 4.5)
cluster_info <- dplyr::select(AllClusters, gene, cluster_6_pearson)
CPM_SC18_all_WT_Zscore_1ColperGene <- pivot_longer(AllClusters, cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") %>%
dplyr::select(gene, seedling, Zscore_normalised_expression) %>%
pivot_wider(names_from = gene, values_from = Zscore_normalised_expression) %>%
column_to_rownames(var="seedling")
Rcor_NRT2.1_genes_clusters <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$AT1G08090, method="spearman")$r) %>%
as.data.frame() %>%
rownames_to_column(var="gene") %>%
dplyr::rename("Rcor" =".") %>%
inner_join(cluster_info, by="gene")
Pcor_NRT2.1_genes_clusters <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$AT1G08090, method="spearman")$p) %>%
as.data.frame()%>%
rownames_to_column(var="gene") %>%
dplyr::rename("Pcor" =".")
Corr_NRT2.1_genes_clusters <- inner_join(Rcor_NRT2.1_genes_clusters, Pcor_NRT2.1_genes_clusters, by="gene") %>%
filter(gene!="AT1G08090")
mutate(Corr_NRT2.1_genes_clusters, cluster_6_pearson=paste("cluster", cluster_6_pearson)) %>%
mutate(cluster_6_pearson=factor(cluster_6_pearson, levels=c("cluster 1", "cluster 2", "cluster 3",
"cluster 4", "cluster 5", "cluster 6")),
logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
facet_wrap(.~cluster_6_pearson, ncol = 3) +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18.5),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
ggsave(file="volcano_plot_cor_NRT2.1_clusters.jpg", width=10, height=5)
Corr_NRT2.1_genes_clusters
filter(Corr_NRT2.1_genes_clusters, cluster_6_pearson!="1") %>%
mutate(cluster_6_pearson=paste("cluster", cluster_6_pearson)) %>%
mutate(cluster_6_pearson=factor(cluster_6_pearson, levels=c("cluster 2", "cluster 3",
"cluster 4", "cluster 5", "cluster 6")),
logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
facet_wrap(.~cluster_6_pearson, ncol = 3) +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18.5),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
cluster_info <- dplyr::select(AllClusters, gene, cluster_6_pearson)
CPM_SC18_all_WT_Zscore_1ColperGene <- pivot_longer(AllClusters, cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") %>%
dplyr::select(gene, seedling, Zscore_normalised_expression) %>%
pivot_wider(names_from = gene, values_from = Zscore_normalised_expression) %>%
column_to_rownames(var="seedling")
Rcor_NRT2.1_genes_clusters <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$AT1G08090, method="spearman")$r) %>%
as.data.frame() %>%
rownames_to_column(var="gene") %>%
dplyr::rename("Rcor" =".") %>%
inner_join(cluster_info, by="gene")
Pcor_NRT2.1_genes_clusters <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$AT1G08090, method="spearman")$p) %>%
as.data.frame()%>%
rownames_to_column(var="gene") %>%
dplyr::rename("Pcor" =".")
Corr_NRT2.1_genes_clusters <- inner_join(Rcor_NRT2.1_genes_clusters, Pcor_NRT2.1_genes_clusters, by="gene") %>%
filter(gene!="AT1G08090")
filter(Corr_NRT2.1_genes_clusters, cluster_6_pearson!="1") %>%
mutate(cluster_6_pearson=paste("cluster", cluster_6_pearson)) %>%
mutate(cluster_6_pearson=factor(cluster_6_pearson, levels=c("cluster 2", "cluster 3",
"cluster 4", "cluster 5", "cluster 6")),
logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
facet_wrap(.~cluster_6_pearson, ncol = 3) +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18.5),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
ggsave(file="volcano_plot_cor_NRT2.1_clusters_except1.jpg", width=10, height=5)
filter(Corr_NRT2.1_genes_clusters, cluster_6_pearson=="1") %>%
mutate(cluster_6_pearson=paste("cluster", cluster_6_pearson), logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18.5),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
filter(Corr_NRT2.1_genes_clusters, cluster_6_pearson=="1") %>%
mutate(cluster_6_pearson=paste("cluster", cluster_6_pearson), logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
ggtitle("Cluster 1") +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18.5),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
filter(Corr_NRT2.1_genes_clusters, cluster_6_pearson=="1") %>%
mutate(cluster_6_pearson=paste("cluster", cluster_6_pearson), logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
ggtitle("Cluster 1") +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18.5),
plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
ggsave(file="volcano_plot_cor_NRT2.1_cluster1.jpg", width=5, height=5)
filter(Corr_NRT2.1_genes_clusters, cluster_6_pearson=="1") %>%
mutate(cluster_6_pearson=paste("cluster", cluster_6_pearson), logCorr=-log(Pcor, 10)) %>%
ggplot( aes(x=Rcor, y=logCorr)) +
geom_point() +
ylab("correlation significance (-log10(p-value)") +
xlab("Spearman coefficient of correlation (R)") +
geom_vline(xintercept = -0.5, col="lightgrey") +
geom_vline(xintercept = 0.5, col="lightgrey") +
geom_hline(yintercept = 1.30103, col="lightgrey") +
ggtitle("Correlation in cluster 1") +
scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"),
axis.text=element_text(size=14), axis.title=element_text(size=18),
plot.title = element_text(size=20),strip.text = element_text( face="bold", size=15),
panel.background = element_rect(fill = "white", colour = "grey50"))
ggsave(file="volcano_plot_cor_NRT2.1_cluster1.jpg", width=5, height=5)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(matrixStats)
library(statmod)
library(scTenifoldNet)
library(RColorBrewer)
library(gplots)
library(topGO)
library(psych)
library(ggpubr)
gene_types <- read_tsv("SC18_data/Genes_interest.txt")
SC18_all_WT <- read_tsv("SC18_data/SC18_Raw_HTSeq_WT.txt") %>%
column_to_rownames(var="gene")
CPMnorm_SC18_all_WT <- cpmNormalization(SC18_all_WT)
CPM_SC18_all_WT <- as.data.frame.matrix(CPMnorm_SC18_all_WT)
CPM_SC18_all_WT_Zscore <- mutate_all(CPM_SC18_all_WT, funs("Zscore" = (.-rowMeans(CPM_SC18_all_WT[,1:24], na.rm=TRUE))/rowSds(as.matrix(CPM_SC18_all_WT[,1:24])))) %>%
dplyr::select( contains("Zscore")) %>%
rename_with(~ gsub("_Zscore", "", .x, fixed = TRUE)) %>%
rownames_to_column(var="gene")
BrenneckeGetVariableGenesMod <- function(expr_mat, spikes=NA, suppress.plot=FALSE, fdr=0.1, minBiolDisp=0.5, fitMeanQuantile=0.8) {
#require(statmod)
rowVars <- function(x) { unlist(apply(x,1,var, na.rm=TRUE))}
colGenes <- "black"
colSp <- "blue"
fullCountTable <- expr_mat;
if (is.character(spikes)) {
sp <- rownames(fullCountTable) %in% spikes;
countsSp <- fullCountTable[sp,];
countsGenes <- fullCountTable[!sp,];
} else if (is.numeric(spikes)) {
countsSp <- fullCountTable[spikes,];
countsGenes <- fullCountTable[-spikes,];
} else {
countsSp <- fullCountTable;
countsGenes <- fullCountTable;
}
meansSp <- rowMeans(countsSp, na.rm=TRUE)
varsSp <- rowVars(countsSp)
cv2Sp <- varsSp/meansSp^2
meansGenes <- rowMeans(countsGenes, na.rm=TRUE)
varsGenes <- rowVars(countsGenes)
cv2Genes <- varsGenes/meansGenes^2
# Fit Model
minMeanForFit <- unname( quantile( meansSp[ which( cv2Sp > 0.3 ) ], fitMeanQuantile))
useForFit <- meansSp >= minMeanForFit
if (sum(useForFit, na.rm=TRUE) < 20) {
warning("Too few spike-ins exceed minMeanForFit, recomputing using all genes.")
meansAll <- c(meansGenes, meansSp)
cv2All <- c(cv2Genes,cv2Sp)
minMeanForFit <- unname( quantile( meansAll[ which( cv2All > 0.3 ) ], 0.80))
useForFit <- meansSp >= minMeanForFit
}
if (sum(useForFit, na.rm=TRUE) < 30) {warning(paste("Only", sum(useForFit), "spike-ins to be used in fitting, may result in poor fit."))}
fit <- glmgam.fit( cbind( a0 = 1.5, a1tilde = 1.1/meansSp[useForFit] ), cv2Sp[useForFit] )
a0 <- unname( fit$coefficients["a0"] )
a1 <- unname( fit$coefficients["a1tilde"])
res <- cv2Genes - (a0 + a1/meansGenes);
# Test
psia1theta <- a1
minBiolDisp <- minBiolDisp^2
m <- ncol(countsSp);
cv2th <- a0 + minBiolDisp + a0 * minBiolDisp
testDenom <- (meansGenes*psia1theta + meansGenes^2*cv2th)/(1+cv2th/m)
p <- 1-pchisq(varsGenes * (m-1)/testDenom,m-1)
padj <- p.adjust(p,"BH")
sig <- padj < fdr
sig[is.na(sig)] <- FALSE
if (!suppress.plot) {
plot( meansGenes,cv2Genes, xaxt="n", yaxt="n", log="xy",
xlab = "average normalized read count",
ylab = "squared coefficient of variation (CV^2)", col="white")
axis( 1, 10^(-2:5), c( "0.01", "0.1", "1", "10", "100", "1000",
expression(10^4), expression(10^5) ) )
axis( 2, 10^(-2:3), c( "0.01", "0.1", "1", "10", "100","1000" ), las=2 )
abline( h=10^(-2:1), v=10^(-1:5), col="#D0D0D0", lwd=2 )
# Plot the genes, use a different color if they are highly variable
#points( meansGenes, cv2Genes, pch=19, cex=.6,
#        col = alpha(ifelse( padj < .1, "blue", colGenes ), 1) )
# Plot/highlight the spike-ins if they are different from the genes
#if (length(meansSp) < length(meansGenes)) {
#  points(meansSp, cv2Sp, pch=20, cex=.5, col=colSp)
#}
# Add the technical noise fit
#xg <- 10^seq( -2, 6, length.out=1000 )
#lines( xg, (a1)/xg + a0, col="red", lwd=3 )
# Add a curve showing the expectation for the chosen biological CV^2 thershold
#lines( xg, psia1theta/xg + a0 + minBiolDisp, lty="dashed", col="purple", lwd=3)
}
TABLE <- data.frame(Gene = names(meansGenes), effect.size=res, p.value = p, q.value= padj, Mean=meansGenes, CV2=cv2Genes ,
TechNoise=(a1)/meansGenes+a0, BioVar=log2(cv2Genes/((a1)/meansGenes+a0)))
TABLE <- TABLE[order(-TABLE[,2]),];
return(list(data=TABLE,A0=a0,A1=a1))
}
CPM_SC18_all_WT_expr <-  filter(CPM_SC18_all_WT, rowMeans(CPM_SC18_all_WT[,1:24])>=5&
rowSums(CPM_SC18_all_WT[1:22]<0.0001)<5)
Gene_size <- read_tsv("SC18_data/TAIR10_Gene_sizes.txt") %>%
dplyr::select(gene_name,length)
Genes_more150bp <-filter(Gene_size,length>150)
CPM_SC18_all_WT_expr <- rownames_to_column(CPM_SC18_all_WT_expr, var="gene") %>%
inner_join( Genes_more150bp, by=c("gene"="gene_name")) %>%
dplyr::select(-length) %>%
column_to_rownames(var="gene") %>%
as.data.frame()
CPM_SC18_all_WT_expr_Brennecke <- BrenneckeGetVariableGenesMod(CPM_SC18_all_WT_expr, minBiolDisp = 0.1, fdr=0.01)
CPM_SC18_all_WT_expr_a0 <-CPM_SC18_all_WT_expr_Brennecke$A0
CPM_SC18_all_WT_expr_a1 <- CPM_SC18_all_WT_expr_Brennecke$A1
CPM_SC18_all_WT_expr_Brennecke_data <- CPM_SC18_all_WT_expr_Brennecke$data
CPM_SC18_all_WT_expr_HVG <- filter(CPM_SC18_all_WT_expr_Brennecke_data, q.value<0.01)
CPM_SC18_all_WT_expr_Brennecke_genes_interest <- inner_join(CPM_SC18_all_WT_expr_Brennecke_data, gene_types, by=c("Gene"="gene"))
ggplot(CPM_SC18_all_WT_expr_Brennecke_data, aes(x=Mean, y=CV2)) +
geom_point() +
scale_x_log10() + scale_y_log10() +
xlab("Mean expression") +
ylab(bquote(CV^2)) +
geom_point(data=CPM_SC18_all_WT_expr_HVG,col="blue") +
geom_point(data=CPM_SC18_all_WT_expr_Brennecke_genes_interest, aes(col=type),  size=5) +
scale_color_brewer(palette = "Dark2", name="Type of gene",
labels=expression("Nitrate assimilation",
"Nitrate transporters",
paste("Negative regulator of ", italic("NRT2.1"), " transcription"),
italic("NRT2.1"),
"NRT2.1 protein regulator",
paste("Positive regulator of ", italic("NRT2.1"), " transcription"))) +
theme_classic() +
theme(text = element_text(size = 20))
ggsave("Variability_graph_genes_nitrate_nutrition.jpg", width=11, height = 4)
View(CPM_SC18_all_WT_expr_HVG)
View(CPM_SC18_all_WT_expr_HVG)
