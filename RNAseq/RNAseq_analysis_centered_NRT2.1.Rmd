---
title: "Profiles for genes of interest"
author: "Sandra"
date: "2023-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, echo=FALSE}
library(tidyverse)
library(matrixStats)
library(statmod)
library(scTenifoldNet)
library(RColorBrewer)
library(gplots)
library(topGO)
library(psych)
library(ggpubr)
```

## Normalisation of samples

### Normalisation by the total number of raw counts (equivalent of mapped library size) 

```{r, message=FALSE, warning=FALSE}

gene_types <- read_tsv("SC18_data/Genes_interest.txt")

SC18_all_WT <- read_tsv("SC18_data/SC18_Raw_HTSeq_WT.txt") %>% 
  column_to_rownames(var="gene")


CPMnorm_SC18_all_WT <- cpmNormalization(SC18_all_WT)

CPM_SC18_all_WT <- as.data.frame.matrix(CPMnorm_SC18_all_WT)

```


### Z-score normalisation on top of the library size normalisation

```{r, message=FALSE, warning=FALSE}

CPM_SC18_all_WT_Zscore <- mutate_all(CPM_SC18_all_WT, funs("Zscore" = (.-rowMeans(CPM_SC18_all_WT[,1:24], na.rm=TRUE))/rowSds(as.matrix(CPM_SC18_all_WT[,1:24])))) %>% 
 dplyr::select( contains("Zscore")) %>% 
  rename_with(~ gsub("_Zscore", "", .x, fixed = TRUE)) %>% 
  rownames_to_column(var="gene") 

```



## Measurement and plot of CV for genes involved in nitrate nutrition

### Get HVG function


```{r, echo=FALSE, message=FALSE}

BrenneckeGetVariableGenesMod <- function(expr_mat, spikes=NA, suppress.plot=FALSE, fdr=0.1, minBiolDisp=0.5, fitMeanQuantile=0.8) {
  #require(statmod)
  rowVars <- function(x) { unlist(apply(x,1,var, na.rm=TRUE))}
  colGenes <- "black"
  colSp <- "blue"
  fullCountTable <- expr_mat;
  if (is.character(spikes)) {
    sp <- rownames(fullCountTable) %in% spikes;
    countsSp <- fullCountTable[sp,];
    countsGenes <- fullCountTable[!sp,];
  } else if (is.numeric(spikes)) {
    countsSp <- fullCountTable[spikes,];
    countsGenes <- fullCountTable[-spikes,];
  } else {
    countsSp <- fullCountTable;
    countsGenes <- fullCountTable;
  }
  meansSp <- rowMeans(countsSp, na.rm=TRUE)
  varsSp <- rowVars(countsSp)
  cv2Sp <- varsSp/meansSp^2
  meansGenes <- rowMeans(countsGenes, na.rm=TRUE)
  varsGenes <- rowVars(countsGenes)
  cv2Genes <- varsGenes/meansGenes^2
  # Fit Model
  minMeanForFit <- unname( quantile( meansSp[ which( cv2Sp > 0.3 ) ], fitMeanQuantile))
  useForFit <- meansSp >= minMeanForFit
  if (sum(useForFit, na.rm=TRUE) < 20) {
    warning("Too few spike-ins exceed minMeanForFit, recomputing using all genes.")
    meansAll <- c(meansGenes, meansSp)
    cv2All <- c(cv2Genes,cv2Sp)
    minMeanForFit <- unname( quantile( meansAll[ which( cv2All > 0.3 ) ], 0.80))
    useForFit <- meansSp >= minMeanForFit
  }
  if (sum(useForFit, na.rm=TRUE) < 30) {warning(paste("Only", sum(useForFit), "spike-ins to be used in fitting, may result in poor fit."))}
  fit <- glmgam.fit( cbind( a0 = 1.5, a1tilde = 1.1/meansSp[useForFit] ), cv2Sp[useForFit] )
  a0 <- unname( fit$coefficients["a0"] )
  a1 <- unname( fit$coefficients["a1tilde"])
  res <- cv2Genes - (a0 + a1/meansGenes);
  # Test
  psia1theta <- a1
  minBiolDisp <- minBiolDisp^2
  m <- ncol(countsSp);
  cv2th <- a0 + minBiolDisp + a0 * minBiolDisp
  testDenom <- (meansGenes*psia1theta + meansGenes^2*cv2th)/(1+cv2th/m)
  p <- 1-pchisq(varsGenes * (m-1)/testDenom,m-1)
  padj <- p.adjust(p,"BH")
  sig <- padj < fdr
  sig[is.na(sig)] <- FALSE
  if (!suppress.plot) {
    plot( meansGenes,cv2Genes, xaxt="n", yaxt="n", log="xy",
          xlab = "average normalized read count",
          ylab = "squared coefficient of variation (CV^2)", col="white")
    axis( 1, 10^(-2:5), c( "0.01", "0.1", "1", "10", "100", "1000",
                           expression(10^4), expression(10^5) ) )
    axis( 2, 10^(-2:3), c( "0.01", "0.1", "1", "10", "100","1000" ), las=2 )
    abline( h=10^(-2:1), v=10^(-1:5), col="#D0D0D0", lwd=2 )
    # Plot the genes, use a different color if they are highly variable
    #points( meansGenes, cv2Genes, pch=19, cex=.6,
    #        col = alpha(ifelse( padj < .1, "blue", colGenes ), 1) )
    # Plot/highlight the spike-ins if they are different from the genes
    #if (length(meansSp) < length(meansGenes)) {
    #  points(meansSp, cv2Sp, pch=20, cex=.5, col=colSp)
    #}
    # Add the technical noise fit
    #xg <- 10^seq( -2, 6, length.out=1000 )
    #lines( xg, (a1)/xg + a0, col="red", lwd=3 )
    # Add a curve showing the expectation for the chosen biological CV^2 thershold
    #lines( xg, psia1theta/xg + a0 + minBiolDisp, lty="dashed", col="purple", lwd=3)
  }
  TABLE <- data.frame(Gene = names(meansGenes), effect.size=res, p.value = p, q.value= padj, Mean=meansGenes, CV2=cv2Genes , 
                      TechNoise=(a1)/meansGenes+a0, BioVar=log2(cv2Genes/((a1)/meansGenes+a0)))
  TABLE <- TABLE[order(-TABLE[,2]),];
  return(list(data=TABLE,A0=a0,A1=a1))
}


```


### HVG plot with genes involved in nitrate nutrition

Removing lowly expressed genes and small genes (<150bp)
```{r, message=FALSE}


CPM_SC18_all_WT_expr <-  filter(CPM_SC18_all_WT, rowMeans(CPM_SC18_all_WT[,1:24])>=5&
                            rowSums(CPM_SC18_all_WT[1:22]<0.0001)<5)


Gene_size <- read_tsv("SC18_data/TAIR10_Gene_sizes.txt") %>% 
  dplyr::select(gene_name,length)

Genes_more150bp <-filter(Gene_size,length>150)

CPM_SC18_all_WT_expr <- rownames_to_column(CPM_SC18_all_WT_expr, var="gene") %>% 
  inner_join( Genes_more150bp, by=c("gene"="gene_name")) %>% 
  dplyr::select(-length) %>% 
  column_to_rownames(var="gene") %>% 
  as.data.frame()



```



HVG plot with genes of interest in different colors
```{r}


CPM_SC18_all_WT_expr_Brennecke <- BrenneckeGetVariableGenesMod(CPM_SC18_all_WT_expr, minBiolDisp = 0.1, fdr=0.01)


CPM_SC18_all_WT_expr_a0 <-CPM_SC18_all_WT_expr_Brennecke$A0 
CPM_SC18_all_WT_expr_a1 <- CPM_SC18_all_WT_expr_Brennecke$A1 
CPM_SC18_all_WT_expr_Brennecke_data <- CPM_SC18_all_WT_expr_Brennecke$data
CPM_SC18_all_WT_expr_HVG <- filter(CPM_SC18_all_WT_expr_Brennecke_data, q.value<0.01)

CPM_SC18_all_WT_expr_Brennecke_genes_interest <- inner_join(CPM_SC18_all_WT_expr_Brennecke_data, gene_types, by=c("Gene"="gene"))


ggplot(CPM_SC18_all_WT_expr_Brennecke_data, aes(x=Mean, y=CV2)) +
  geom_point() +
  scale_x_log10() + scale_y_log10() +
  xlab("Mean expression") +
  ylab(bquote(CV^2)) +
  geom_point(data=CPM_SC18_all_WT_expr_HVG,col="blue") +
 geom_point(data=CPM_SC18_all_WT_expr_Brennecke_genes_interest, aes(col=type),  size=5) +
  scale_color_brewer(palette = "Dark2", name="Type of gene",
                     labels=expression("Nitrate assimilation",
                     "Nitrate transporters",
                     paste("Negative regulator of ", italic("NRT2.1"), " transcription"),
                     italic("NRT2.1"), 
                     "NRT2.1 protein regulator",
                     paste("Positive regulator of ", italic("NRT2.1"), " transcription"))) +
  theme_classic() +
  theme(text = element_text(size = 20))

ggsave("Variability_graph_genes_nitrate_nutrition.jpg", width=11, height = 4)



```



## Correlation between the expression in seedlings of NRT2.1 and different genes involved in nitrate nutrition


Tables of correlation between each gene and NRT2.1
```{r}
options(scipen=999)

CPM_SC18_all_WT_Zscore_1ColperGene <- inner_join(CPM_SC18_all_WT_Zscore, gene_types, by="gene") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") %>% 
  dplyr::select(-type, - gene) %>% 
  pivot_wider(names_from = name, values_from = Zscore_normalised_expression) %>% 
  column_to_rownames(var="seedling")

Rcor_NRT2.1_genes <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene[-1], function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$NRT2.1, method="spearman")$r) %>% 
  as.data.frame()
Pcor_NRT2.1_genes <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene[-1], function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$NRT2.1, method="spearman")$p) %>% 
  as.data.frame()


```




Graph with 1 ribbon per type of gene (Z-score). Stars are added next to the name of the gene to indicate correlation: * < 0.05; ** < 0.01; *** < 0.005
```{r}

CPM_SC18_all_WT_Zscore_long <- inner_join(CPM_SC18_all_WT_Zscore, gene_types, by="gene") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 


NRT2.1_CPM_SC18_all_WT_Zscore_long <- filter(CPM_SC18_all_WT_Zscore_long, gene=="AT1G08090") %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))

CPM_SC18_all_WT_Zscore_long_lessNRT2.1 <- filter(CPM_SC18_all_WT_Zscore_long, gene!="AT1G08090")

# Graph for N transporters

CPM_SC18_all_WT_Zscore_long_lessNRT2.1_N_transport <- filter(CPM_SC18_all_WT_Zscore_long_lessNRT2.1,
                                                                 type=="N_transport")



my_colors <- RColorBrewer::brewer.pal(8, "Oranges")[5:8]

ggplot(NRT2.1_CPM_SC18_all_WT_Zscore_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_point(size=2) +
  geom_line(data=CPM_SC18_all_WT_Zscore_long_lessNRT2.1_N_transport, aes(x=seedling, y=Zscore_normalised_expression, group=name, color=name), size=1.5) +
  ylab("Zscore of \nnormalised expression") +
  ggtitle("Nitrate transporters") +
  scale_color_manual(values=my_colors, labels=c(expression(bolditalic("NRT1.1")), "NRT1.2", 
                                                expression(bolditalic("NRT2.4")), "NRT2.5")) +
  theme(legend.text=element_text(size=16,face = "italic" ),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=18), axis.title=element_text(size=21.5),
        plot.title = element_text(size=24),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), legend.key = element_rect(fill = NA, color = NA))


ggsave("Correlation_NRT2.1_Ntransporters_seedlings.jpg", width=5, height=4)

```


```{r}
# Graph for genes involved in N assimilation

my_colors_greens <- RColorBrewer::brewer.pal(9, "Greens")[4:9]


CPM_SC18_all_WT_Zscore_long_lessNRT2.1_Nassimilation <- filter(CPM_SC18_all_WT_Zscore_long_lessNRT2.1,
                                                                 type=="N_assimilation")

ggplot(NRT2.1_CPM_SC18_all_WT_Zscore_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_point(size=2) +
  geom_line(data=CPM_SC18_all_WT_Zscore_long_lessNRT2.1_Nassimilation, aes(x=seedling, y=Zscore_normalised_expression, group=name, color=name), size=1.5) +
  ylab("Zscore normalised expression") +
  ggtitle("Nitrate assimilation") +
  scale_color_manual(values=my_colors_greens, labels=c("GLN2", "GLU1", "GLU2", "NIA1" , 
                                                       "NIA2",expression(bolditalic("NIR1")))) +
  theme(legend.text=element_text(size=16,face = "italic" ),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=18), axis.title=element_text(size=21.5),
        plot.title = element_text(size=24),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), legend.key = element_rect(fill = NA, color = NA))

ggsave("Correlation_NRT2.1_Nassimilation_seedlings.jpg", width=5, height=4)

```



```{r}
# Graph for genes involved in NRT2.1 protein regulation


my_colors_lightgreens <- RColorBrewer::brewer.pal(9, "YlGn")[c(3,5)]


CPM_SC18_all_WT_Zscore_long_lessNRT2.1_NprotRegul <- filter(CPM_SC18_all_WT_Zscore_long_lessNRT2.1,
                                                                 type=="NRT2.1_protein_regulation")

ggplot(NRT2.1_CPM_SC18_all_WT_Zscore_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_point(size=2) +
  geom_line(data=CPM_SC18_all_WT_Zscore_long_lessNRT2.1_NprotRegul, aes(x=seedling, y=Zscore_normalised_expression, group=name, color=name), size=1.5) +
  scale_color_manual(values=my_colors_lightgreens, labels=c(expression(bolditalic("NAR2.1")),  
                                                       expression(bolditalic("PP2C")))) +
  ylab("Zscore normalised expression") +
  ggtitle("NRT2.1 protein regulation") +
  theme(legend.text=element_text(size=16,face = "italic" ),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=18), axis.title=element_text(size=21.5),
        plot.title = element_text(size=24),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), legend.key = element_rect(fill = NA, color = NA))

ggsave("Correlation_NRT2.1_NprotRegulation_seedlings.jpg", width=5, height=4)


```


```{r}

# Graph for genes involved in negative regulation of NRT2.1 gene

my_colors_purples <- c(RColorBrewer::brewer.pal(9, "PuRd")[2:3],RColorBrewer::brewer.pal(9, "Purples")[3:9])



CPM_SC18_all_WT_Zscore_long_lessNRT2.1_NnegRegul <- filter(CPM_SC18_all_WT_Zscore_long_lessNRT2.1,
                                                                 type=="Negative_regulator_NRT2.1")

ggplot(NRT2.1_CPM_SC18_all_WT_Zscore_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_point(size=2) +
  geom_line(data=CPM_SC18_all_WT_Zscore_long_lessNRT2.1_NnegRegul, aes(x=seedling, y=Zscore_normalised_expression, group=name, color=name), size=1.5) +
   scale_color_manual(values=my_colors_purples, labels=c("BT1", "BT2", "HHO1", "HHO2", "HH3",
                                                             "HRS1", "LBD37", "LBD38", "LBD39")) +
  ylab("Zscore normalised expression") +
  ggtitle(expression(paste("Negative regulator of ", italic("NRT2.1")))) +
  theme(legend.text=element_text(size=16,face = "italic" ),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=18), axis.title=element_text(size=21.5),
        plot.title = element_text(size=24),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), legend.key = element_rect(fill = NA, color = NA))

ggsave("Correlation_NRT2.1_NegativeRegulator_seedlings.jpg", width=5, height=4)

```


```{r}

# Graph for genes involved in positive regulation of NRT2.1 gene

my_colors_darkYellow <- RColorBrewer::brewer.pal(9, "YlOrRd")[1:5]



CPM_SC18_all_WT_Zscore_long_lessNRT2.1_NposRegul <- filter(CPM_SC18_all_WT_Zscore_long_lessNRT2.1,
                                                                 type=="Positive_regulator_NRT2.1")

ggplot(NRT2.1_CPM_SC18_all_WT_Zscore_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_point(size=2) +
  geom_line(data=CPM_SC18_all_WT_Zscore_long_lessNRT2.1_NposRegul, aes(x=seedling, y=Zscore_normalised_expression, group=name, color=name), size=1.5) +
  scale_color_manual(values=my_colors_darkYellow, labels=c("CEP9", "NLP2", "TGA1", "TGA4", "TGA7")) +
  ylab("Zscore normalised expression") +
  ggtitle(expression(paste("Positive regulator of ", italic("NRT2.1")))) +
  theme(legend.text=element_text(size=16,face = "italic" ),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=18), axis.title=element_text(size=21.5),
        plot.title = element_text(size=24),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), legend.key = element_rect(fill = NA, color = NA)) 

ggsave("Correlation_NRT2.1_PositiveRegulator_seedlings.jpg", width=5, height=4)

```







## Heatmap and hierarchical clustering of genes to see what is correlated with NRT2.1

### Heatmap on Zscore

```{r}
CPM_SC18_all_WTgenes_Zscore <- mutate_all(CPM_SC18_all_WT, funs("Zscore" = (.-rowMeans(CPM_SC18_all_WT[,1:24], na.rm=TRUE))/rowSds(as.matrix(CPM_SC18_all_WT[,1:24])))) %>% 
  dplyr::select( contains("Zscore")) %>% 
  rename_with(~ gsub("_Zscore", "", .x, fixed = TRUE)) %>% 
  rownames_to_column(var="gene")

CPM_SC18_all_WT_Zscore_BioVarsupp1 <- inner_join(CPM_SC18_all_WTgenes_Zscore, CPM_SC18_all_WT_expr_Brennecke_data,
                                                by=c("gene"="Gene")) %>% 
  filter(BioVar>= 1) %>% 
  mutate(NRT21=case_when(gene=="AT1G08090" ~ "NRT2.1"))




CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson <- cor(t(CPM_SC18_all_WT_Zscore_BioVarsupp1[,2:25]), method = "pearson")
CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson[is.na(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson)]<-0
CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist<-as.dist((1-CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson))
CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist[is.na(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist)]<-0
CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete <- hclust(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist, 
                                                       method="complete")
CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete.den <- as.dendrogram(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete)
CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete.col=brewer.pal(12, 'Set3')[cutree(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete, k = 6)]
CPM_SC18_all_WT_Zscore_BioVarsupp1$cluster_6_pearson <- cutree(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete, 
                                             k = 6)
CPM_SC18_all_WT_Zscore_BioVarsupp1$cluster_6_pearson_color <- brewer.pal(12, 'Set3')[cutree(CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete, k = 6)]


heatmap.2(as.matrix(CPM_SC18_all_WT_Zscore_BioVarsupp1[,2:25]),  
          Rowv=CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete.den, 
          col = bluered(100), breaks=seq(-0.5,0.5,length.out=101), trace = 'none' ,
          labRow=CPM_SC18_all_WT_Zscore_BioVarsupp1$NRT21, labCol=names(CPM_SC18_all_WT_Zscore_BioVarsupp1[,2:25]), 
          main="Zscore for genes variable",
          RowSideColors = CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete.col,
          na.rm=F, na.color="black")



pdf("heatmap_clusters_single_seedlings_CVsup1_NRT21.pdf")
heatmap.2(as.matrix(CPM_SC18_all_WT_Zscore_BioVarsupp1[,2:25]),  
          Rowv=CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete.den, 
          col = bluered(100), breaks=seq(-0.5,0.5,length.out=101), trace = 'none' ,
          labRow=CPM_SC18_all_WT_Zscore_BioVarsupp1$NRT21, labCol=names(CPM_SC18_all_WT_Zscore_BioVarsupp1[,2:25]), 
          main="Zscore for genes variable",
          RowSideColors = CPM_SC18_all_WT_Zscore_BioVarsupp1.pearson.dist.clust.complete.col,
          na.rm=F, na.color="black")
dev.off()


write_tsv(CPM_SC18_all_WT_Zscore_BioVarsupp1, file="6clusters_genesCVsup1_NRT21.txt")

```


# Profile of clusters compared with NRT2.1

```{r}
AllClusters <- read_tsv("6clusters_genesCVsup1_NRT21.txt")
```

plot profile of NRT2.1 and profile of cluster1 where NRT2.1 is
```{r}
Cluster1_long <- filter(AllClusters, cluster_6_pearson==1) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 
  

NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))


ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=1.5, aes(group=gene)) +
  geom_smooth(data=Cluster1_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
  scale_color_manual(values="#8DD3C7") +
  ylab("Zscore normalised expression") +
  ggtitle("Expression in cluster 1") +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), 
        legend.position = "none")

ggsave("Expression_cluster1_NRT2.1.jpg", width=5, height = 5)

```





plot profile of NRT2.1 and profile of cluster2
```{r}
Cluster2_long <- filter(AllClusters, cluster_6_pearson==2) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 
  

NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))


ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=1.5, aes(group=gene)) +
  geom_smooth(data=Cluster2_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
  scale_color_manual(values="#FFFFB3") +
  ylab("Zscore normalised expression") +
  ggtitle("Expression in cluster 2") +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), 
        legend.position = "none")

ggsave("Expression_cluster2_NRT2.1.jpg", width=5, height = 5)

```



plot profile of NRT2.1 and profile of cluster3
```{r}
Cluster3_long <- filter(AllClusters, cluster_6_pearson==3) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 
  

NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))


ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=1.5, aes(group=gene)) +
  geom_smooth(data=Cluster3_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
  scale_color_manual(values="#BEBADA") +
  ylab("Zscore normalised expression") +
  ggtitle("Expression in cluster 3") +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), 
        legend.position = "none")

ggsave("Expression_cluster3_NRT2.1.jpg", width=5, height = 5)

```



plot profile of NRT2.1 and profile of cluster4
```{r}
Cluster4_long <- filter(AllClusters, cluster_6_pearson==4) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 
  

NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))


ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=1.5, aes(group=gene)) +
  geom_smooth(data=Cluster4_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
  scale_color_manual(values="#FB8072") +
  ylab("Zscore normalised expression") +
  ggtitle("Expression in cluster 4") +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), 
        legend.position = "none")

ggsave("Expression_cluster4_NRT2.1.jpg", width=5, height = 5)

```



plot profile of NRT2.1 and profile of cluster5
```{r}
Cluster5_long <- filter(AllClusters, cluster_6_pearson==5) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 
  

NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))


ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=1.5, aes(group=gene)) +
  geom_smooth(data=Cluster5_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
  scale_color_manual(values="#80B1D3") +
  ylab("Zscore normalised expression") +
  ggtitle("Expression in cluster 5") +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), 
        legend.position = "none")

ggsave("Expression_cluster5_NRT2.1.jpg", width=5, height = 5)

```



plot profile of NRT2.1 and profile of cluster6
```{r}
Cluster6_long <- filter(AllClusters, cluster_6_pearson==6) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 
  

NRT2.1_long <- filter(AllClusters, gene=="AT1G08090") %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression")  %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))


ggplot(NRT2.1_long, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=1.5, aes(group=gene)) +
  geom_smooth(data=Cluster6_long, aes(x=seedling, y=Zscore_normalised_expression, group=cluster_6_pearson, color=cluster_6_pearson_color)) +
  scale_color_manual(values="#FDB462") +
  ylab("Zscore normalised expression") +
  ggtitle("Expression in cluster 6") +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(), 
        legend.position = "none")

ggsave("Expression_cluster6_NRT2.1.jpg", width=5, height = 5)

```


# Volcano plot showing the correlation of genes in each cluster with NRT2.1

```{r}

cluster_info <- dplyr::select(AllClusters, gene, cluster_6_pearson)

CPM_SC18_all_WT_Zscore_1ColperGene <- pivot_longer(AllClusters, cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") %>% 
  dplyr::select(gene, seedling, Zscore_normalised_expression) %>% 
  pivot_wider(names_from = gene, values_from = Zscore_normalised_expression) %>% 
  column_to_rownames(var="seedling")


Rcor_NRT2.1_genes_clusters <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$AT1G08090, method="spearman")$r) %>% 
  as.data.frame() %>% 
  rownames_to_column(var="gene") %>% 
  dplyr::rename("Rcor" =".") %>% 
  inner_join(cluster_info, by="gene")


Pcor_NRT2.1_genes_clusters <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene$AT1G08090, method="spearman")$p) %>% 
  as.data.frame()%>% 
  rownames_to_column(var="gene") %>% 
  dplyr::rename("Pcor" =".")

Corr_NRT2.1_genes_clusters <- inner_join(Rcor_NRT2.1_genes_clusters, Pcor_NRT2.1_genes_clusters, by="gene") %>% 
  filter(gene!="AT1G08090")



mutate(Corr_NRT2.1_genes_clusters, cluster_6_pearson=paste("cluster", cluster_6_pearson)) %>% 
  mutate(cluster_6_pearson=factor(cluster_6_pearson, levels=c("cluster 1", "cluster 2", "cluster 3", 
                                  "cluster 4", "cluster 5", "cluster 6")),
       logCorr=-log(Pcor, 10)) %>% 
ggplot( aes(x=Rcor, y=logCorr)) +
  geom_point() +
  ylab("correlation significance (-log10(p-value)") +
  xlab("Spearman coefficient of correlation (R)") +
  geom_vline(xintercept = -0.5, col="lightgrey") +
  geom_vline(xintercept = 0.5, col="lightgrey") +
  geom_hline(yintercept = 1.30103, col="lightgrey") +
  facet_wrap(.~cluster_6_pearson, ncol = 3) +
  scale_color_brewer(palette="Set2", name="P-value",labels=c("less0.05"="Lower than 0.05", "more0.05"="Higher than 0.05"))+
   theme(legend.text=element_text(size=15),legend.title = element_text(size=15, face="bold"), 
        axis.text=element_text(size=14), axis.title=element_text(size=18.5),
        plot.title = element_text(size=16),strip.text = element_text( face="bold", size=15),
        panel.background = element_rect(fill = "white", colour = "grey50"))

ggsave(file="volcano_plot_cor_NRT2.1_clusters.jpg", width=10, height=5)

```



## Comparison with targets of NLP7



Tables of correlation between each gene and NRT2.1 for NLP7 targets
```{r}
options(scipen=999)

targets_NLP7 <- read_tsv("NLP7_targets_Marchive_2013.txt")

CPM_SC18_all_WT_Zscore_1ColperGene_nlp7 <- inner_join(CPM_SC18_all_WT_Zscore, targets_NLP7, by=c("gene"="AGI")) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") %>% 
  dplyr::select(-type, -nitrate_response_nlp7_compared_wt) %>% 
  pivot_wider(names_from = gene, values_from = Zscore_normalised_expression) %>% 
  column_to_rownames(var="seedling")

Rcor_NRT2.1_genes_nlp7 <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene_nlp7, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene_nlp7$AT1G08090, method="spearman")$r) %>% 
  as.data.frame() %>% 
  rownames_to_column(var="gene") %>% 
  dplyr::rename("Rcor" =".") %>% 
  inner_join(targets_NLP7, by=c("gene"="AGI"))


Pcor_NRT2.1_genes_nlp7 <- sapply(CPM_SC18_all_WT_Zscore_1ColperGene_nlp7, function(x) corr.test(x, CPM_SC18_all_WT_Zscore_1ColperGene_nlp7$AT1G08090, method="spearman")$p) %>% 
  as.data.frame()%>% 
  rownames_to_column(var="gene") %>% 
  dplyr::rename("Pcor" =".")

Corr_NRT2.1_genes_nlp7 <- inner_join(Rcor_NRT2.1_genes_nlp7, Pcor_NRT2.1_genes_nlp7, by="gene") %>% 
  filter(gene!="AT1G08090")


```



```{r}

## Ribbon for NLP7 targets


targets_NLP7 <- read_tsv("NLP7_targets_Marchive_2013.txt")

CPM_SC18_all_WT_Zscore_long_nlp7 <- inner_join(CPM_SC18_all_WT_Zscore, targets_NLP7, by=c("gene"="AGI")) %>% 
  pivot_longer( cols = c(A1:A9), names_to = "seedling", values_to = "Zscore_normalised_expression") 


CPM_SC18_all_WT_Zscore_long_NRT21 <- filter(CPM_SC18_all_WT_Zscore_long_nlp7, gene=="AT1G08090") %>% 
  mutate(seedling=fct_reorder(seedling, Zscore_normalised_expression))

CPM_SC18_all_WT_Zscore_long_lessNRT2.1_nlp7 <- filter(CPM_SC18_all_WT_Zscore_long_nlp7, gene!="AT1G08090")


ggplot(CPM_SC18_all_WT_Zscore_long_NRT21, aes(x=seedling, y=Zscore_normalised_expression)) +
  geom_line(size=2) +
  geom_smooth(data=CPM_SC18_all_WT_Zscore_long_lessNRT2.1_nlp7, aes(x=seedling, y=Zscore_normalised_expression, group=type, color=type), size=1.5) +
  geom_point(size=2) +
  ylab("Zscore normalised expression") +
  ggtitle(expression(paste("Genes regulated by ", italic("NLP7")))) +
  theme(legend.text=element_text(size=16),legend.title = element_text(size=16, face="bold"), 
        axis.text=element_text(size=16), axis.title=element_text(size=16),
        plot.title = element_text(size=18),
        panel.background = element_rect(fill = "white", colour = "grey50"),axis.text.x=element_blank(),
        legend.position = "none")


ggsave("Expression_nlp7Targets_smooth_NRT2.1.jpg", width=5, height = 5)





```




